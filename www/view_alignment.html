<html>
  <head>
    <meta charset="utf-8" />
    <style>
html, body {
    margin: 0;
    padding: 0;
}
#header {
    position: fixed;
    top: 0;
    left: 0;
    height: 50px;
    line-height: 50px;
    width: 100%;
    background-color: #999;
    box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.5);
    font-family: Helvetica, sans-serif;
}
#header, #header a {
    color: white;
}
.download {
    float: right;
    margin: 0 15px;
}
.home {
    background: #666;
    font-size: 125%;
    padding-left: 25px;
    padding-right: 30px;
    margin-right: 20px;
    float: left;
    text-decoration: none;
    font-weight: lighter;
    text-transform: lowercase;
}
#audio {
    margin-top: 9px;
    width: 50%;
    display: inline-block;
}
#transcript {
    margin: 0 15px;
    margin-top: 70px;
    white-space: pre-wrap;
    line-height: 2em;
    max-width: 600px;
}
.active {
    color: magenta;
}
.dud {
    color: #999;
}
    </style>
  </head>
  <body>
    <div id="header">
      <a href="/" class="home">Gentle</a>
      <audio id="audio" src="a.wav" controls="true"></audio>
      <a href="align.json" class="download">Download JSON</a><a href="align.csv" class="download">Download CSV</a>
    </div>
    <div id="transcript"></div>

    <script>

function get(url, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onload = function() {
        cb(this.responseText);
    }
    xhr.send();
}
function get_json(url, cb) {
    get(url, function(x) {
        cb(JSON.parse(x));
    });
}

var $a = document.getElementById("audio");
window.onkeydown = function(ev) {
    if(ev.keyCode == 32) {
        ev.preventDefault();
        $a.pause();
    }
}

var $trans = document.getElementById("transcript");

var $cur_p;
function do_break() {
    $cur_p = document.createElement("p");
    $trans.appendChild($cur_p);
}

var wds = [];
var cur_wd;

function highlight_word() {
    if(cur_wd) {
        cur_wd.$div.classList.remove("active");
    }
    var t = $a.currentTime;
    // XXX: O(N); use binary search
    var hits = wds.filter(function(x) { return x.start <= t && x.end >= t; }, wds);
    if(hits.length > 0) {
        cur_wd = hits[0];
        cur_wd.$div.classList.add("active");
    }

    window.setTimeout(highlight_word, 1000/10);
}

highlight_word();

$trans.innerHTML = "Loading...";

get_json("align.json", function(ret) {
    wds = ret['words'];
    
    $trans.innerHTML = "";
    do_break();
    
    wds.forEach(function(wd) {

        var $wd = document.createElement("span");
        $wd.innerHTML = (wd.word || wd.alignedWord) + " ";
        wd.$div = $wd;

        $wd.onclick = function() {
            if(wd.start !== undefined) {
                console.log(wd.start);
                $a.currentTime = wd.start;
                $a.play();
            }
        }

        if(wd['case'] == 'not-found-in-transcript') {
            // TODO: show phonemes somewhere
        }
        else {
            if(wd.start == undefined) {
                $wd.className = "dud";
            }
            $cur_p.appendChild($wd);

            // newline to break
            if(wd.word[wd.word.length-1]=='\n') {
                do_break();
            }

            
        }
        
    });

});

</script></body></html>
